<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="initial-scale=1,user-scalable=no,maximum-scale=1,width=device-width">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">

    <!-- Leaflet & teman2 (punyamu) -->
    <link rel="stylesheet" href="css/leaflet.css">
    <link rel="stylesheet" href="css/L.Control.Layers.Tree.css">
    <link rel="stylesheet" href="css/qgis2web.css">
    <link rel="stylesheet" href="css/fontawesome-all.min.css">
    <link rel="stylesheet" href="css/leaflet.photon.css">
    <link rel="stylesheet" href="css/leaflet-measure.css">

    <style>
      html, body, #map { width:100%; height:100%; padding:0; margin:0; }
    </style>

    <link href="https://fonts.googleapis.com/css2?family=Roboto+Slab:wght@700&display=swap" rel="stylesheet">

    <style>
      /* --- JUDUL --- */
      #judul-container{
        position:absolute; top:20px; left:50px; display:flex; align-items:center;
        background:rgba(255,255,255,.7); backdrop-filter:blur(5px);
        padding:5px 15px 5px 10px; border-radius:10px; box-shadow:0 4px 12px rgba(0,0,0,.2);
        z-index:999999;
      }
      #logo-desa{ height:60px; object-fit:contain; margin-right:10px; }
      #judul-animasi{ font-family:'Poppins',sans-serif; font-size:30px; font-weight:bold; color:#2c3e50; margin:0; }
      @media (max-width:768px){
        #judul-container{ left:10px; padding:8px 20px; top:10px; }
        #judul-animasi{ font-size:20px; } #logo-desa{ height:40px; }
      }

      /* --- TOGGLE BUTTON --- */
      .toggle-button{
        position:absolute; top:80px; right:20px; z-index:99999; background:orange;
        padding:10px 18px; border-radius:10px; font-size:14px; cursor:pointer;
        box-shadow:0 2px 6px rgba(0,0,0,.2); font-family:'Poppins',sans-serif;
        font-weight:bold; color:#fff; border:none;
      }

      /* --- PANEL INFO --- */
      #info-box{
        position:absolute; top:130px; right:20px; width:300px;
        background:rgba(255,255,255,.75); border-radius:12px; padding:15px;
        box-shadow:0 4px 8px rgba(0,0,0,.3); z-index:9997; display:none;
        backdrop-filter:blur(6px); font-family:'Poppins',sans-serif;
      }
      #info-box h3{ margin:0 0 8px; font-size:16px; color:#2c3e50; }

      .stat-container{ margin-top:6px; }
      .stat-header{
        background:rgba(17,63,103,.8); padding:6px 12px; border-radius:20px;
        text-align:center; font-weight:bold; font-size:14px; margin-bottom:10px; color:#fff;
      }
      .stat-box{
        background:rgba(17,63,103,.8); border-radius:10px; padding:12px; margin-bottom:10px;
        text-align:center; box-shadow:0 3px 8px rgba(0,0,0,.2);
      }
      .stat-value{ font-size:24px; font-weight:bold; color:#fff; }
      .stat-label{ font-size:13px; color:#fff; margin-top:4px; }

      /* --- TABS KATEGORI CHART --- */
      .category-buttons{ display:flex; flex-wrap:wrap; gap:8px; margin:8px 0 6px; }
      .category-buttons button{
        flex:1 1 calc(50% - 8px); padding:6px 8px; border:none; border-radius:8px; cursor:pointer;
        background:#e9eef9; color:#2c3e50; font-weight:600; font-size:12px;
      }
      .category-buttons button.active{ background:#2563eb; color:#fff; }
      .chart-wrap{ padding:8px 6px; }
      canvas{ max-width:100%; }
    </style>

    <title></title>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>
  <body>
    <div id="map"></div>

    <div id="judul-container">
      <img id="logo-desa" src="img/logo_desa.png" alt="Logo Desa">
      <div id="judul-animasi">PETA TEMATIK DESA AIR BELO</div>
    </div>

    <button class="toggle-button" onclick="toggleInfo()">Tampilkan Visualisasi</button>

    <div id="info-box">
      <h3>Informasi Penduduk</h3>

      <div class="stat-container">
        <div class="stat-header">üìç Desa Air Belo</div>
        <div class="stat-box">
          <div class="stat-value" id="jumlah-penduduk">0</div>
          <div class="stat-label">Jumlah Penduduk</div>
        </div>
        <div class="stat-box">
          <div class="stat-value" id="persen-industri">0%</div>
          <div class="stat-label">Lapangan Usaha Industri Pengolahan</div>
        </div>
      </div>

      <!-- Tombol kategori chart -->
      <div class="category-buttons">
        <button id="btn-kategori" onclick="showChart('kategori')">Kategori</button>
        <button id="btn-status"   onclick="showChart('status')">Status Pekerjaan</button>
        <button id="btn-gender"   onclick="showChart('gender')">Jenis Kelamin</button>
        <button id="btn-age"      onclick="showChart('age')">Kategori Umur</button>
      </div>

      <div class="chart-wrap">
        <canvas id="donutChart" width="240" height="240"></canvas>
      </div>
    </div>

    <!-- ====== SCRIPTS PETA (punyamu, tidak diubah kecuali penempatan) ====== -->
    <script src="js/qgis2web_expressions.js"></script>
    <script src="js/leaflet.js"></script>
    <script src="js/L.Control.Layers.Tree.min.js"></script>
    <script src="js/leaflet.rotatedMarker.js"></script>
    <script src="js/leaflet.pattern.js"></script>
    <script src="js/leaflet-hash.js"></script>
    <script src="js/Autolinker.min.js"></script>
    <script src="js/rbush.min.js"></script>
    <script src="js/labelgun.min.js"></script>
    <script src="js/labels.js"></script>
    <script src="js/leaflet.photon.js"></script>
    <script src="js/leaflet-measure.js"></script>
    <script src="data/AIRBELO_MENTOK_1.js"></script>

    <script>
      // === Map init (ringkas, sama seperti punyamu) ===
      var map = L.map('map', { zoomControl:false, maxZoom:17, minZoom:2 });
      var hash = new L.Hash(map);
      L.control.zoom({ position:'topleft' }).addTo(map);
      var measureControl = new L.Control.Measure({
        position:'topleft', primaryLengthUnit:'feet', secondaryLengthUnit:'miles',
        primaryAreaUnit:'sqfeet', secondaryAreaUnit:'sqmiles'
      }).addTo(map);
      document.getElementsByClassName('leaflet-control-measure-toggle')[0].innerHTML = '';
      document.getElementsByClassName('leaflet-control-measure-toggle')[0].className += ' fas fa-ruler';

      map.createPane('pane_GoogleSatellite_0');
      map.getPane('pane_GoogleSatellite_0').style.zIndex = 400;
      var layer_GoogleSatellite_0 = L.tileLayer('https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
        pane:'pane_GoogleSatellite_0', opacity:1.0,
        attribution:'<a href="https://www.google.at/permissions/geoguidelines/attr-guide.html">Map data ¬©2015 Google</a>',
        minZoom:2, maxZoom:17, minNativeZoom:0, maxNativeZoom:20
      }).addTo(map);

      function pop_AIRBELO_MENTOK_1(feature, layer){
        var popupContent =
          '<table>'
          + '<tr><td colspan="2">'+(feature.properties['rt'] ?? '')+'</td></tr>'
          + '<tr><td colspan="2">'+(feature.properties['dusun'] ?? '')+'</td></tr>'
          + '</table>';
        layer.bindPopup(popupContent, { maxHeight: 400 });
      }
      function style_AIRBELO_MENTOK_1_0(){ return {
        pane:'pane_AIRBELO_MENTOK_1', opacity:1, color:'rgba(255,245,235,1.0)',
        dashArray:'10.0,2.0', lineCap:'butt', lineJoin:'miter', weight:2.0,
        fill:true, fillOpacity:1, fillColor:'rgba(231,113,72,0.51)', interactive:true
      } }
      map.createPane('pane_AIRBELO_MENTOK_1');
      map.getPane('pane_AIRBELO_MENTOK_1').style.zIndex = 401;
      var layer_AIRBELO_MENTOK_1 = new L.geoJson(json_AIRBELO_MENTOK_1, {
        attribution:'', interactive:true, pane:'pane_AIRBELO_MENTOK_1',
        onEachFeature:pop_AIRBELO_MENTOK_1, style:style_AIRBELO_MENTOK_1_0
      }).addTo(map);
      var bounds_group = new L.featureGroup([layer_AIRBELO_MENTOK_1]);
      if (bounds_group.getLayers().length) map.fitBounds(bounds_group.getBounds());
    </script>

    <!-- ====== CHART & INTERAKSI PANEL ====== -->
    <script>
      /* ===================== DATA (edit sesuai data riil) ===================== */
      const chartData = {
        // 1) Kategori: Bekerja vs Tidak Bekerja
        kategori: {
          title: 'Kategori: Bekerja vs Tidak Bekerja',
          labels: ['Bekerja','Tidak Bekerja'],
          data:   [750, 484],
          colors: ['#10b981','#ef4444']
        },
        // 2) Status Pekerjaan (8 item)
        status: {
          title: 'Status Pekerjaan',
          labels: [
            'Berusaha sendiri',
            'Berusaha dibantu buruh tidak tetap',
            'Berusaha dibantu buruh tetap',
            'Buruh/karyawan/pegawai swasta',
            'PNS/TNI/POLRI/BUMN',
            'Pekerja bebas pertanian',
            'Pekerja bebas non pertanian',
            'Pekerja keluarga/tidak dibayar'
          ],
          data:   [220, 140, 60, 520, 85, 70, 90, 49],
          colors: ['#2563eb','#22c55e','#f59e0b','#ef4444','#8b5cf6','#14b8a6','#0ea5e9','#6b7280']
        },
        // 3) Jenis Kelamin
        gender: {
          title: 'Jenis Kelamin',
          labels: ['Laki-laki','Perempuan'],
          data:   [2300, 2005],
          colors: ['#3b82f6','#ec4899']
        },
        // 4) Kategori Umur (5 rentang)
        age: {
          title: 'Kategori Umur',
          labels: ['15-24','25-34','35-44','45-54','55-64'],
          data:   [500, 900, 1200, 900, 805],
          colors: ['#93c5fd','#60a5fa','#3b82f6','#1d4ed8','#1e3a8a']
        }
      };

      let chartInstance;

      // helper: hitung total
      function sum(arr){ return arr.reduce((a,b)=>a+Number(b||0),0); }

      // Build chart untuk tipe tertentu
      function buildChart(type){
        const cfg = chartData[type];
        const total = sum(cfg.data);

        const ctx = document.getElementById('donutChart').getContext('2d');
        if (chartInstance) chartInstance.destroy();

        chartInstance = new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels: cfg.labels,
            datasets: [{
              data: cfg.data,
              backgroundColor: cfg.colors,
              hoverOffset: 4
            }]
          },
          options: {
            responsive: true,
            cutout: '50%',
            plugins: {
              title: {
                display: true,
                text: cfg.title,
                font: { weight: 'bold', size: 14 }
              },
              legend: {
  position: 'bottom',
  labels: {
    // Tampilkan label + jumlah + (%)
    generateLabels(chart){
      const ds = chart.data.datasets[0];
      const labels = chart.data.labels || [];
      return labels.map((lbl, i) => ({
        text: lbl,  // <-- cuma label saja
        fillStyle: ds.backgroundColor[i],
        strokeStyle: ds.backgroundColor[i],
        lineWidth: 0,
        hidden: false,
        index: i
      }));
    }
  }
},
              tooltip: {
                callbacks: {
                  // tooltip: Label: jumlah (xx.xx%)
                  label(ctx){
                    const val = Number(ctx.raw || 0);
                    const tot = sum(ctx.dataset.data);
                    const pct = tot ? ((val / tot) * 100).toFixed(2) : 0;
                    return `${ctx.label}: ${val.toLocaleString()} (${pct}%)`;
                  }
                }
              }
            }
          }
        });

        // set tombol aktif
        document.querySelectorAll('.category-buttons button').forEach(b => b.classList.remove('active'));
        const btnId = {
          kategori:'#btn-kategori',
          status:'#btn-status',
          gender:'#btn-gender',
          age:'#btn-age'
        }[type];
        document.querySelector(btnId).classList.add('active');
      }

      // Angka animasi header kecil
      function animateValue(id, start, end, duration, suffix=''){
        const obj = document.getElementById(id);
        let t0 = null;
        const step = (ts)=>{
          if(!t0) t0 = ts;
          const p = Math.min((ts - t0)/duration, 1);
          const raw = p*(end-start)+start;
          const val = suffix==='%' ? raw.toFixed(2) : Math.floor(raw);
          obj.innerHTML = Number(val).toLocaleString()+suffix;
          if(p<1) requestAnimationFrame(step);
        };
        requestAnimationFrame(step);
      }

      // Toggle panel
      function toggleInfo(){
        const box = document.getElementById('info-box');
        const btn = document.querySelector('.toggle-button');
        const visible = box.style.display === 'block';
        box.style.display = visible ? 'none' : 'block';
        btn.innerText   = visible ? 'Tampilkan Visualisasi' : 'Sembunyikan Visualisasi';
        if(!visible){
          // default tampilkan kategori "Bekerja vs Tidak Bekerja"
          buildChart('kategori');
          animateValue('jumlah-penduduk', 0, 3300, 1200);
          animateValue('persen-industri', 0, 28.75, 1200, '%');
        }
      }

      // Aksi klik tab chart
      function showChart(type){ buildChart(type); }

      // optional: buka panel saat load pertama? uncomment:
      // window.addEventListener('load', () => toggleInfo());
    </script>
  </body>
</html>
